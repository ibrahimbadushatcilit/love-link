<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Love Letters</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap");

      @import url("https://fonts.googleapis.com/css2?family=Anek+Malayalam:wght@300;500;700&display=swap");

      .letter-malayalam {
        font-family: "Anek Malayalam", sans-serif !important;
      }

      :root {
        --envelope-x: 300px;
        --envelope-y: 200px;
        --envelope-bg: Moccasin;
        --envelope-shadow: Peru;
        --letter-x: 250px;
        --letter-y: calc(200px - 1rem - 10px);
        --letter-bg: AntiqueWhite;
        --letter-shadow: BurlyWood;
        --letter-text: #180d07;
        --letter-font: "Dancing Script", serif;
        --letter-button-text: #d01760;
        --heart-bg: #d01760;
        --heart-text: white;
      }

      @media (min-width: 650px) {
        :root {
          --envelope-x: 600px;
          --envelope-y: 400px;
          --letter-x: 500px;
          --letter-y: calc(400px - 1rem - 10px);
        }
      }
      html {
        font-size: 20px;
      }
      body {
        background-color: #d01760;
      }
      a {
        text-decoration: none;
      }
      .cssletter {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        margin: 24dvh 0;
      }

      .envelope {
        position: relative;
        width: var(--envelope-x);
        height: var(--envelope-y);
        background: var(--envelope-bg);
        box-shadow:
          inset 0 0 30px -5px var(--envelope-shadow),
          0 0 50vw 0 #540000;
      }

      .envelope::before {
        content: "˚ʚ❤︎ɞ˚";
        font-size: 5rem;
        color: white;
        position: absolute;
        left: 50%;
        top: 30%;
        transform: translate(-50%, -50%);
        mix-blend-mode: soft-light;
      }

      .envelope-flap {
        width: 100%;
        height: 71%;
        position: absolute;
        top: 0;
        z-index: 3;
        overflow: hidden;
        transition: 0.6s linear all;
        transform-origin: top;
        pointer-events: all;
      }

      .envelope-folds {
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 2;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .envelope-flap::before,
      .envelope-left::before,
      .envelope-right::before,
      .envelope-bottom::before {
        content: "";
        transform: rotate(45deg);
        background: var(--envelope-bg);
        box-shadow: 0 0 30px -5px var(--envelope-shadow);
        width: 100%;
        aspect-ratio: 1;
        display: block;
        position: absolute;
        top: 60%;
      }

      .envelope-flap::before {
        border-radius: 5rem;
        bottom: 30px;
        border-radius: 5rem;
        top: auto;
      }

      @media (min-width: 650px) {
        .envelope-flap::before {
          bottom: 100px;
        }
      }

      .envelope-left::before {
        top: 10%;
        left: -65%;
      }

      .envelope-right::before {
        top: 10%;
        right: -65%;
      }

      .envelope-bottom::before {
        top: 60%;
        border-radius: 5rem;
      }

      .heart {
        z-index: 4;
        position: relative;
        box-shadow: none;
        border: none;
        width: 70px;
        aspect-ratio: 1;
        background:
          radial-gradient(circle at 60% 65%, var(--heart-bg) 64%, #0000 65%) top
            left/50% 50%,
          radial-gradient(circle at 40% 65%, var(--heart-bg) 64%, #0000 65%) top
            right/50% 50%,
          conic-gradient(
              from -45deg at 50% 85.5%,
              var(--heart-bg) 90deg,
              #0000 0
            )
            bottom/100% 50%;
        background-repeat: no-repeat;
        left: 50%;
        top: 70%;
        transform: translate(-50%, -50%);
        cursor: pointer;
      }

      @media (min-width: 650px) {
        .heart {
          width: 150px;
        }
      }

      .heart::before {
        content: "";
        display: block;
        position: absolute;
        width: 70px;
        aspect-ratio: 1;
        background:
          radial-gradient(circle at 60% 65%, #ffffff26 64%, #0000 65%) top
            left/50% 50%,
          radial-gradient(circle at 40% 65%, #ffffff26 64%, #0000 65%) top
            right/50% 50%,
          conic-gradient(from -45deg at 50% 85.5%, #ffffff26 90deg, #0000 0)
            bottom/100% 50%;
        background-repeat: no-repeat;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(0);
        transition: 0.3s ease all;
        z-index: -1;
      }

      @media (min-width: 650px) {
        .heart::before {
          width: 150px;
        }
      }

      .heart:hover,
      .heart:active,
      .heart:focus {
        transform: translate(-50%, -50%);
        background-color: transparent;
        color: var(--heart-text);
      }

      .heart:hover::before,
      .heart:active::before,
      .heart:focus::before {
        transform: translate(-50%, -50%) scale(0.8);
      }

      .heart-text {
        transform: translateY(-10px);
        display: block;
        color: var(--heart-text);
        font-size: 1.5rem;
        font-family: var(--letter-font);
      }

      .envelope.active * {
        pointer-events: none;
      }

      .envelope.active .envelope-flap {
        transform: rotateX(-180deg) translateY(0);
        perspective: 10px;
      }

      .envelope.active .envelope-flap::before {
        box-shadow: inset 0 0 30px -5px var(--envelope-shadow);
      }

      .envelope.active .heart {
        display: none;
      }

      .letter {
        box-sizing: border-box;
        font-family: var(--letter-font);
        font-size: 1rem;
        line-height: 1.1;
        background-color: var(--letter-bg);
        color: var(--letter-text);
        width: var(--letter-x);
        min-height: var(--letter-y);
        max-height: var(--letter-y);
        height: fit-content;
        user-select: none;
        box-shadow: inset 0 0 20px -5px var(--letter-shadow);
        padding: 3rem 1rem 1rem;
        margin: 0;
        cursor: grab;
        position: absolute;
        top: -2rem;
        overflow: auto;
        text-align: center;
        border: 0;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }

      .envelope.active ~ .letters .letter {
        opacity: 1;
        pointer-events: auto;
        transition-delay: 0.6s;
      }

      .letter:active {
        cursor: grabbing;
      }

      .letter.center {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      .letter cite {
        font-size: 1.25rem;
        color: var(--letter-text);
        margin-top: 1rem;
      }

      .letter cite::before {
        content: none;
      }

      .letter:nth-child(even) {
        transform: skew(-2deg) translateY(-4px);
      }

      .letter:nth-child(odd) {
        transform: skew(2deg) translateY(4px);
      }

      @media (min-width: 650px) {
        .letter {
          font-size: 1.3rem;
        }
      }

      .closeLetter {
        font-size: 0 !important;
        position: absolute;
        top: 10px;
        right: 10px;
        left: auto;
        transform: none;
        background: none;
        box-shadow: none;
        padding: 0;
        border: 0;
      }

      .closeLetter::before {
        content: "✖";
        font-size: 1.5rem !important;
        font-family: sans-serif;
        color: var(--letter-button-text);
        text-align: center;
      }

      .closeLetter:hover,
      .closeLetter:active,
      .closeLetter:focus {
        background-color: transparent;
        color: var(--letter-text);
        transform: none;
        padding: 0;
        margin: 0;
      }

      .closeLetter:hover::before,
      .closeLetter:active::before,
      .closeLetter:focus::before {
        content: "✖";
      }

      /* Attribution */
      @import url("https://frills.dev/css/abstracts/_variables.css");
      @import url("https://frills.dev/css/components/_logo.css");

      :root {
        --bodybg: darkred;
      }

      footer {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        z-index: 10000000;
      }

      footer svg {
        width: 100px;
      }

      @media (max-width: 650px) {
        html {
          font-size: 16px;
        }
        .cssletter {
          margin: 10vh 0;
        }
        footer {
          position: static;
          width: 100%;
          text-align: center;
          margin-top: 2rem;
          padding-bottom: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <section class="cssletter">
      <div class="envelope">
        <button class="heart" id="openEnvelope" aria-label="Open Envelope">
          <span class="heart-text">Open</span>
        </button>
        <div class="envelope-flap"></div>
        <div class="envelope-folds">
          <div class="envelope-left"></div>
          <div class="envelope-right"></div>
          <div class="envelope-bottom"></div>
        </div>
      </div>
      <div class="letters">
        <blockquote
          class="letter center letter-malayalam"
          id="1"
          tabindex="0"
          style="left: 390px"
        >
          <button class="closeLetter" title="Close the letter">
            Close letter
          </button>

          <img
            src="https://pngimg.com/uploads/rose/rose_PNG639.png"
            alt="Red Rose"
            style="
              width: 65px;
              margin-bottom: 12px;
              filter: drop-shadow(2px 3px 5px rgba(0, 0, 0, 0.15));
            "
          />

          <div style="padding: 0 15px">
            <p style="font-size: 0.75rem; color: #555; margin-bottom: 5px">
              Dear,
            </p>

            <p
              style="
                font-size: 0.75rem;
                line-height: 1.6;
                color: #1a1a1a;
                font-weight: 300;
              "
            >
              എന്റെ ജീവിതത്തിലെ ഏറ്റവും മനോഹരമായ നിമിഷം നിന്നോടൊപ്പമുള്ളവയാണ്. ഈ
              പ്രണയദിനത്തിൽ എന്റെ ഹൃദയം നിനക്കായി സമർപ്പിക്കുന്നു...
              ജീവിതത്തിന്റെ അവസാനം വരെ എന്റെ ഓരോ ശ്വാസത്തിലും നിന്റെ കൂട്ട്
              എനിക്കുണ്ടാകുമോ?

              <span
                style="
                  display: block;
                  margin: 12px 0;
                  color: #b00000;
                  font-weight: 700;
                  font-size: 0.75rem;
                "
              >
                നമുക്ക് ഒന്നായി ജീവിച്ചു തീർക്കാം, ഈ ജന്മം മുഴുവൻ?
              </span>

              എന്റെ പ്രണയം എന്നും നിന്നോടൊപ്പം ഉണ്ടാകും.
            </p>
          </div>

          <cite style="font-size: 0.5rem; color: #d10000; font-weight: 500"
            >ഹൃദയപൂർവ്വം ❤️</cite
          >
        </blockquote>

        <blockquote
          class="letter center"
          id="2"
          tabindex="0"
          style="left: 390px"
        >
          <button class="closeLetter" title="Close Oliver's letter"></button>
          <p></p>
          <cite></cite>
        </blockquote>
      </div>
    </section>
    <div class="text-center mt-4">
      <button
        type="button"
        class="btn btn-outline-light"
        data-bs-toggle="modal"
        data-bs-target="#linkModal"
      >
        Create a Link for your Partner ❤️
      </button>
    </div>

    <div
      class="modal fade"
      id="linkModal"
      tabindex="-1"
      aria-labelledby="linkModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="linkModalLabel">
              Create your Love Link
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="linkForm">
              <div class="mb-3">
                <label for="yourName" class="form-label">Your Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="yourName"
                  placeholder="e.g. Oliver"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="partnerName" class="form-label"
                  >Partner's Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="partnerName"
                  placeholder="e.g. Amelia"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="customMessage" class="form-label"
                  >Your Message</label
                >
                <textarea
                  class="form-control"
                  id="customMessage"
                  rows="3"
                  placeholder="Write something sweet..."
                  required
                ></textarea>
              </div>

              <div id="resultArea" class="mt-3 d-none">
                <label class="form-label text-success">Share this link:</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="generatedLink"
                    readonly
                  />
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    id="copyBtn"
                  >
                    Copy
                  </button>
                  <a
                    class="btn btn-success"
                    id="whatsappBtn"
                    href="#"
                    target="_blank"
                    role="button"
                    >WhatsApp</a
                  >
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="submit" form="linkForm" class="btn btn-danger">
              Generate Link
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p class="text-white">
        Designed & Developed By
        <a
          href="https://www.facebook.com/profile.php?id=100009857252152"
          target="_blank"
          style="direction: none; color: white"
        >
          <strong>IBA</strong></a
        >
      </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const letters = document.querySelectorAll(".letter");
      const lettersContainer = document.querySelector(".letters");
      let zIndexCounter = 10;

      const shuffleArray = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      };

      const shuffledThings = Array.from(letters);
      shuffleArray(shuffledThings);

      shuffledThings.forEach((letter) => {
        lettersContainer.appendChild(letter);
        const center =
          document.querySelector(".cssletter").offsetWidth / 2 -
          letter.offsetWidth / 2;
        letter.style.left = `${center}px`;

        function isOverflown(element) {
          return (
            element.scrollHeight > element.clientHeight ||
            element.scrollWidth > element.clientWidth
          );
        }

        if (!isOverflown(letter)) {
          letter.classList.add("center");
        }
        let offsetX, offsetY;

        const startDrag = (e) => {
          if (e.target.tagName === "BUTTON" || e.target.tagName === "A") return;

          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;

          const rect = letter.getBoundingClientRect();

          letter.style.position = "fixed";
          letter.style.left = `${rect.left}px`;
          letter.style.top = `${rect.top}px`;

          offsetX = clientX - rect.left;
          offsetY = clientY - rect.top;

          letter.style.zIndex = zIndexCounter++;
          letter.style.maxHeight = "none";

          const moveAt = (posX, posY) => {
            letter.style.left = `${posX - offsetX}px`;
            letter.style.top = `${posY - offsetY}px`;
          };

          const onMove = (moveEvent) => {
            if (moveEvent.type === "touchmove") {
              moveEvent.preventDefault(); // Prevent scrolling while dragging
            }
            const moveX = moveEvent.touches
              ? moveEvent.touches[0].clientX
              : moveEvent.clientX;
            const moveY = moveEvent.touches
              ? moveEvent.touches[0].clientY
              : moveEvent.clientY;
            moveAt(moveX, moveY);
          };

          const onEnd = () => {
            document.removeEventListener("mousemove", onMove);
            document.removeEventListener("mouseup", onEnd);
            document.removeEventListener("touchmove", onMove);
            document.removeEventListener("touchend", onEnd);
          };

          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", onEnd);
          document.addEventListener("touchmove", onMove, { passive: false });
          document.addEventListener("touchend", onEnd);
        };

        letter.addEventListener("mousedown", startDrag);
        letter.addEventListener("touchstart", startDrag, { passive: false });
      });
      document.querySelector("#openEnvelope").addEventListener("click", () => {
        document.querySelector(".envelope").classList.add("active");
      });
      const closeButtons = document.querySelectorAll(".closeLetter");
      closeButtons.forEach((button) => {
        button.addEventListener("click", (e) => {
          e.preventDefault();
          const letter = e.target.closest(".letter");
          if (letter) {
            letter.style.display = "none";
          }
        });
      });
    </script>
    <script>
      document
        .getElementById("linkForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Get raw values from form
          const sender = document.getElementById("yourName").value;
          const receiver = document.getElementById("partnerName").value;
          const msg = document.getElementById("customMessage").value;

          // --- Send to Google Sheet ---
          // TODO: Replace the URL below with your deployed Google Apps Script Web App URL
          const scriptURL =
            "https://script.google.com/macros/s/AKfycbw0deMrTSwd0j-y-7aZtuqHtaQRpkOLwmYHCey1yl-oZJdONZQwYZGy5gd_y0Xe3_F6LQ/exec";

          const requestData = new FormData();
          requestData.append("sender", sender);
          requestData.append("receiver", receiver);
          requestData.append("message", msg);

          fetch(scriptURL, {
            method: "POST",
            body: requestData,
            mode: "no-cors",
          })
            .then(() => console.log("Request sent (check Sheet for data)"))
            .catch((error) => console.error("Error saving to sheet:", error));

          // Create a data object and "encrypt" it by Base64 encoding
          const data = { from: sender, to: receiver, m: msg };
          const encodedData = btoa(JSON.stringify(data));

          // Construct the URL
          const baseUrl = window.location.href.split("?")[0];
          const finalUrl = `${baseUrl}?data=${encodedData}`;

          // Show the result
          const resultArea = document.getElementById("resultArea");
          const linkInput = document.getElementById("generatedLink");
          const whatsappBtn = document.getElementById("whatsappBtn");

          linkInput.value = finalUrl;
          whatsappBtn.href = `https://wa.me/?text=${encodeURIComponent(finalUrl)}`;
          resultArea.classList.remove("d-none");
        });

      // Copy to clipboard functionality
      document.getElementById("copyBtn").addEventListener("click", function () {
        const linkInput = document.getElementById("generatedLink");
        navigator.clipboard
          .writeText(linkInput.value)
          .then(() => {
            const originalText = this.innerText;
            this.innerText = "Copied!";
            setTimeout(() => {
              this.innerText = originalText;
            }, 2000);
          })
          .catch((err) => {
            console.error("Could not copy text: ", err);
            alert("Failed to copy link.");
          });
      });

      // ------

      window.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has("data")) {
          try {
            const encodedData = urlParams.get("data");
            const decodedJson = atob(encodedData);
            const data = JSON.parse(decodedJson);
            const { from, to, m: message } = data;

            const letterToUpdate = document.getElementById("2");
            if (letterToUpdate) {
              letterToUpdate.querySelector("p").innerText =
                `Dear ${to},\n\n${message}`;
              letterToUpdate.querySelector("cite").innerText =
                `ഹൃദയപൂർവ്വം ❤️ ${from}`;
              letterToUpdate.querySelector(".closeLetter").title =
                `Close ${from}'s letter`;
            }

            const staticLetter = document.getElementById("1");
            if (staticLetter) {
              staticLetter.querySelector("cite").innerText =
                `ഹൃദയപൂർവ്വം ❤️ ${from}`;
            }
          } catch (e) {
            console.error("Failed to parse shared data from URL:", e);
          }
        }
      });
    </script>
  </body>
</html>
